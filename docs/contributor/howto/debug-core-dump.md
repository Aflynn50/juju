# Debug dqlite segmentation faults / core dumps

The guide will show you how to retrieve the necessary information to diagnose and fix issues with dqlite segmentation faults or core dumps.

The segmentation fault will manifest itself in the logs, with a message similar to:

```
/etc/systemd/system/jujud-machine-0-exec-start.sh: line 11:  5862 Segmentation fault      (core dumped) '/var/lib/juju/tools/machine-0/jujud' machine --data-dir '/var/lib/juju' --machine-id 0 --debug
```

Alternatively, you may see a core dump based on an assertion failure, such as:

```
Assertion failed: type == SQLITE_INTEGER || type == SQLITE_NULL (src/query.c: value_type: 23)
signal: aborted (core dumped)
```

We'll show you how to retrieve the necessary information to diagnose and fix these issues.

## Retrieve the core dump

In order to get the backtrace (the stack trace of the error) we need to be able reproduce the issue. There is no way to get the backtrace from a core dump that was generated by a process that has already exited with all the information we require. This is because we strip the symbols from the binary to reduce the size of the binary.

The first step is to remove the `-s` flag from the `CFLAGS` in the `Makefile` of the jujud-controller. This will ensure that the symbols are not stripped from the binary.

Bootstrap the controller with the modified binary. Once the controller is running, connect to the machine and install the `gdb` package:

```bash
sudo apt install gdb
```

Once that's installed, we need to stop the controller (assuming it's machine 0), as we're going to start the controller with `gdb`:

```bash
sudo systemctl stop jujud-machine-0.service
```

Now we can start the controller with `gdb`:

```bash
LIBDQLITE_TRACE=1 gdb -ex=r --args /var/lib/juju/tools/machine-0/jujud machine --data-dir "/var/lib/juju" --machine-id 0 --debug
```

This will start the controller with `gdb` and run it until it crashes. If you encounter SIGPIPE errors, you can either continue on the breakpoint or ignore the SIGPIPE signal with the following command:

```
handle SIGPIPE nostop noprint pass
```

Continue the gdb session and then reproduce the issue. Once the controller crashes, it should put you back into the gdb prompt. At this point, you can get the backtrace with the following command:

```
bt
```

Grab the output of the backtrace and share it with the Juju team. They will be able to help you diagnose the issue further.




